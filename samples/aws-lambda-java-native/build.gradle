plugins {
    id 'com.github.johnrengelman.shadow' version '6.1.0'
    id 'com.bmuschko.docker-remote-api' version '6.7.0'
    id 'java'
}

import com.bmuschko.gradle.docker.tasks.container.*
import com.bmuschko.gradle.docker.tasks.image.*

group = 'io.redskap'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

repositories {
    mavenCentral()
    maven {
        url 'https://oss.sonatype.org/content/repositories/snapshots/'
    }
}

dependencies {
    implementation 'io.redskap:aws-lambda-java-runtime:0.0.1-SNAPSHOT'

    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.3.1'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.3.1'
}

test {
    useJUnitPlatform()
}

shadowJar {
    manifest {
        attributes 'Main-Class': 'io.redskap.lambda.runtime.sample.NativeApp'
    }
}

task buildNativeImage(type: DockerBuildImage) {
    inputDir = project.rootDir
    images.add('aws-lambda-java-native')
}

task createContainer(type: DockerCreateContainer) {
    dependsOn buildNativeImage
    targetImageId buildNativeImage.getImageId()
    hostConfig.autoRemove = true
    tty = true
}

task startContainer(type: DockerStartContainer) {
    dependsOn createContainer
    targetContainerId createContainer.getContainerId()
}

task copyNativePackageFromContainer(type: DockerCopyFileFromContainer) {
    dependsOn startContainer
    targetContainerId createContainer.getContainerId()
    hostPath = "${project.buildDir}/function.zip"
    remotePath = '/home/application/function.zip'
}

task stopNativeContainer(type: DockerStopContainer) {
    dependsOn copyNativePackageFromContainer
    targetContainerId createContainer.getContainerId()
}

task buildNative() {
    dependsOn stopNativeContainer
}